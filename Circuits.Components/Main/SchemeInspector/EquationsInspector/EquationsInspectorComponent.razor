@using Circuits.Services.Extensions
@using Circuits.ViewModels.Entities.Structures

<div class="equation-inspector">

    <div class="scroller">
        <div class="commands">
            <ControlButtonComponent Label="Build Equation Systems" OnClick="OnBuildEquationSystems"/>
            <ControlButtonComponent Label="Perform Gaussian Elimination" OnClick="OnPerformGaussianElimination"/>
            <ControlButtonComponent Label="Clear Scheme" OnClick="OnClear"/>
        </div>

        <div class="separator">
            <div class="line"></div>
        </div>

        <div class="circuits">

            @for (var i = 0; i < SchemeService.Graphs.Count; i++)
            {
                var graph = SchemeService.Graphs[i];
                var graphBranches = graph.Circuits.SelectMany(circuit => circuit.Branches).ToList();
                var circuitBranches = graph.Circuits
                    .SelectMany(c => c.Branches
                        .Select(b => new CircuitBranch
                        {
                            Circuit = c,
                            Branch = b
                        }));

                <BCHSelect TItem="CircuitBranch"
                           Width="120"
                           Options="@circuitBranches"
                           Height="300"
                           Filtering="false"
                           Grouping="true"
                           MultipleSelect="true"
                           DefaultText="@($"Graph {i}")"
                           GroupPredicate="x => x.Circuit"
                           FilterByPredicate='x => $"branch {x.Circuit.Branches.IndexOf(x.Branch)}"'
                           OnSelectItem="(e) => { OnBranchSelected(e.Branch, true); }"
                           OnDeselectItem="(e) => { OnBranchSelected(e.Branch, false); }">

                    <GroupTemplate Context="circuitObj">
                        @{ var circuit = (Circuit)circuitObj!; }

                        <div class="circuit-wrapper">
                            <div class="name noselectable-text">Circuit <i class="noselectable-text">@(graph.Circuits.IndexOf(circuit))</i></div>
                            <div class="controls">
                                <div
                                    @onclick="() => { OnShowCircuitDirectionClicked(circuit); }"
                                    @onclick:stopPropagation
                                    class="@($"icon {(HighlightService.ShouldShowDirection(circuit) ? "selected" : "")}")">
                                    D
                                </div>
                            </div>
                        </div>
                    </GroupTemplate>

                    <RowTemplate Context="cb">
                        <div class="branch-wrapper">
                            <div class="name noselectable-text">Branch <i class="noselectable-text">@(graphBranches.IndexOf(cb.Branch))</i></div>
                            <div class="controls">
                                <div
                                    @onclick="() => { OnShowBranchDirectionClicked(cb.Branch); }"
                                    @onclick:stopPropagation
                                    class="@($"icon {(HighlightService.ShouldShowDirection(cb.Branch) ? "selected" : "")}")">
                                    D
                                </div>
                            </div>
                        </div>
                    </RowTemplate>

                </BCHSelect>
            }
        </div>

        <div class="equations">
            @foreach (var equationSystem in SchemeService.EquationSystems)
            {
                <div class="separator">
                    <div class="line"></div>
                </div>

                <div class="equation-system-container">
                    <GraphEquationSystemComponent EquationSystem="equationSystem"/>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .equation-inspector > .scroller .circuits > .bch-select-container {
        display: inline-block;
        margin: 5px;
    }
</style>